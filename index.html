<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<meta charset="utf-8">
<head>
<link rel="stylesheet" href="css/modal.css">
<link rel="stylesheet" href="css/main.css">
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>

<div id="mdlParams" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <span class="close">&times;</span>
      <h2>Parameters</h2>
    </div>
    <div class="modal-body">
      <p>Press ESC, the close button, or click outside to close this dialog.</p>
      <div class="params">
        <table>
        <tr><td><label for="numAttendings">Number of Attendings</label></td><td><input type="text" id="numAttendings" value="2" /></td></tr>
        <tr><td><label for="numClinicalTeams">Number of Clinical Teams</label></td><td><input type="text" id="numClinicalTeams" value="4"  /></td></tr>
        <tr><td><label for="numPatients">Number of Patients</label></td><td><input type="text" id="numPatients" value="8" /></td></tr>
        <tr><td><label for="targetTime">Target clinic end time (minutes)</label></td><td><input type="text" id="targetTime" value="180" /></td></tr>
        <tr><td><label for="hurryThreshold">Hurry threshold (minutes)</label></td><td><input type="text" id="hurryThreshold" value="30"  /></td></tr>
        <tr><td><label for="hurryFactor">Hurry factor (multiplicative)</label></td><td><input type="text" id="hurryFactor" value="0.5" /></td></tr>
        </table>
      </div>
      <div id="confirmParams"><button class="btn btn-warning" id="btnConfirmParams">Confirm changes</button> &nbsp; (this will reset the properties below)</div>
      <div class="params">
        <div id="patients"></div>
        <div id="distributions"></div>
      </div>
    </div>
  </div>
</div>

<div id="mdlJSON" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <span class="close">&times;</span>
      <h2>JSON import/export</h2>
    </div>
    <div class="modal-body">
      <p>Import and export simulation parameters using JSON</p>
      <div style="width:49%;display:inline-block;">
        <textarea id="txtImport" class="json" rows="20">
{
  "numAttendings": 2,
  "numClinicalTeams": 4,
  "numPatients": 8,
  "targetTime": 180,
  "hurryThreshold": 30,
  "hurryFactor": 0.75,
  "actors": {
    "attendings": [
      {
        "id": "Attending-1"
      },
      {
        "id": "Attending-2"
      }
    ],
    "clinicalTeams": [
      {
        "id": "ClinicalTeam-1"
      },
      {
        "id": "ClinicalTeam-2"
      },
      {
        "id": "ClinicalTeam-3"
      },
      {
        "id": "ClinicalTeam-4"
      }
    ],
    "patients": [
      {
        "id": "Patient-1",
        "preferredAttending": "Attending-1",
        "preferredClinicalTeam": "ClinicalTeam-1",
        "caseType": "uc",
        "maxWaitTimeAttending": 15,
        "maxWaitTimeClinicalTeam": 30,
        "appointmentTime": 15
      },
      {
        "id": "Patient-2",
        "preferredAttending": "Attending-2",
        "preferredClinicalTeam": "ClinicalTeam-2",
        "caseType": "uc",
        "maxWaitTimeAttending": 15,
        "maxWaitTimeClinicalTeam": 30,
        "appointmentTime": 15
      },
      {
        "id": "Patient-3",
        "preferredAttending": "Attending-1",
        "preferredClinicalTeam": "ClinicalTeam-3",
        "caseType": "btc_fu",
        "maxWaitTimeAttending": 15,
        "maxWaitTimeClinicalTeam": 30,
        "appointmentTime": 30
      },
      {
        "id": "Patient-4",
        "preferredAttending": "Attending-2",
        "preferredClinicalTeam": "ClinicalTeam-4",
        "caseType": "btc_fu",
        "maxWaitTimeAttending": 15,
        "maxWaitTimeClinicalTeam": 30,
        "appointmentTime": 30
      },
      {
        "id": "Patient-5",
        "preferredAttending": "Attending-1",
        "preferredClinicalTeam": "ClinicalTeam-1",
        "caseType": "btc_new",
        "maxWaitTimeAttending": 15,
        "maxWaitTimeClinicalTeam": 30,
        "appointmentTime": 60
      },
      {
        "id": "Patient-6",
        "preferredAttending": "Attending-2",
        "preferredClinicalTeam": "ClinicalTeam-2",
        "caseType": "btc_new",
        "maxWaitTimeAttending": 15,
        "maxWaitTimeClinicalTeam": 30,
        "appointmentTime": 60
      },
      {
        "id": "Patient-7",
        "preferredAttending": "Attending-1",
        "preferredClinicalTeam": "ClinicalTeam-3",
        "caseType": "uc",
        "maxWaitTimeAttending": 15,
        "maxWaitTimeClinicalTeam": 30,
        "appointmentTime": 75
      },
      {
        "id": "Patient-8",
        "preferredAttending": "Attending-2",
        "preferredClinicalTeam": "ClinicalTeam-4",
        "caseType": "uc",
        "maxWaitTimeAttending": 15,
        "maxWaitTimeClinicalTeam": 30,
        "appointmentTime": 75
      }
    ]
  },
  "distributions": {
    "pt_checkin": {
      "min": 2,
      "max": 10,
      "mean": 5,
      "stdev": 2
    },
    "pt_checkout": {
      "min": 1,
      "max": 20,
      "mean": 5,
      "stdev": 3
    },
    "pt_arrival_delay": {
      "min": -60,
      "max": 60,
      "mean": -6,
      "stdev": 14
    },
    "pt_ct_meeting_btc_new": {
      "min": 15,
      "max": 75,
      "mean": 45,
      "stdev": 10
    },
    "pt_ct_meeting_btc_fu": {
      "min": 15,
      "max": 75,
      "mean": 30,
      "stdev": 5
    },
    "pt_ct_meeting_uc": {
      "min": 15,
      "max": 75,
      "mean": 30,
      "stdev": 8
    },
    "ct_atp_meeting": {
      "min": 2,
      "max": 25,
      "mean": 10,
      "stdev": 4
    },
    "pt_ct_atp_meeting_btc_new": {
      "min": 15,
      "max": 75,
      "mean": 20,
      "stdev": 8
    },
    "pt_ct_atp_meeting_btc_fu": {
      "min": 5,
      "max": 60,
      "mean": 15,
      "stdev": 5
    },
    "pt_ct_atp_meeting_uc": {
      "min": 5,
      "max": 60,
      "mean": 15,
      "stdev": 5
    }
  }
}
        </textarea>
        <button class="btn btn-warning" id="btnLoadJSON">Import JSON</button>
      </div>
      <div style="width:49%;float:right;">
        <textarea id="txtExport" class="json" rows="20"></textarea>
        <button class="btn btn-primary" id="btnExportJSON">Export JSON</button>
      </div>
    </div>
  </div>
</div>

<div id="menu">
<button class="btn btn-primary" id="btnShowParams" data-modal="mdlParams">Parameters</button>
<button class="btn btn-primary" id="btnShowJSON" data-modal="mdlJSON">JSON import/export</button>
<button class="btn btn-primary" id="btnRunSingle">Run Simulation</button>
<button class="btn btn-primary" id="btnRunMonteCarlo">Run Monte Carlo</button>
</div>

<div id="legend"></div>
<div id="timelines"></div>
<div id="info"></div>


<div id="mc">
<style>.plot { width: 50%; height: 300px; float: left; }</style>
<div id="pltTimeHist" class="plot"></div>
<div id="pltPatientTotalTimeInClinic" class="plot"></div>

<div id="pltPatientWaitingForClinicalTeam" class="plot"></div>
<div id="pltPatientWaitingForAttending" class="plot"></div>

<div id="pltClinicalTeamWaitingForPatient" class="plot"></div>
<div id="pltClinicalTeamWaitingForAttending" class="plot"></div>

<div id="pltClinicalTeamPatientsSeen" class="plot"></div>
<div id="pltAttendingPatientsSeen" class="plot"></div>

<div id="pltPatientPreferred" class="plot"></div>
<div id="pltAttendingWaitingForClinicalTeam" class="plot"></div>
</div>
<script src="js/modal.js"></script>
<script src="js/application.js"></script>
<script src="js/math.js"></script>
<script src="js/actor.js"></script>
<script src="js/simulation.js"></script>
<script src="js/scheduler.js"></script>

<script>

var app = new Application();

app.createSession();

document.getElementById('btnConfirmParams').onclick = function() {
  app.createSession();
};

document.getElementById('btnExportJSON').onclick = function() {
  var params = app.getParams();
  document.getElementById('txtExport').value = JSON.stringify(params, null, '  ');
};

document.getElementById('btnLoadJSON').onclick = function() {
  var params = JSON.parse(document.getElementById('txtImport').value);
  app.setParams(params);
  modal.show('mdlParams');
};

document.getElementById('btnRunSingle').addEventListener('click', function() {
  var params = app.getParams();
  var sim = new Simulation();
  var scheduler = new Scheduler();
  sim.run(params, scheduler);
  visualize(sim);
});

var simulationWorker = new Worker('js/worker.js');

document.getElementById('btnRunMonteCarlo').addEventListener('click', function() {
  var params = app.getParams();
  simulationWorker.postMessage({
    action: 'runMonteCarlo',
    params: params,
    numSamps: 5000
  });
  this.innerHTML = 'Running Monte Carlo';
});

simulationWorker.onmessage = function(message) {
  if (message.data.action == 'runMonteCarlo') {
    var results = message.data.results;
    showMonteCarloResults(results);
    document.getElementById('btnRunMonteCarlo').innerHTML = 'Run Monte Carlo';
  }
};

document.getElementById('btnLoadJSON').click();

var hist = function(data, min, max, n_bins) {
  var width = (max - min) / (n_bins - 1);
  var counts = [];
  var bins = [];
  for (var i = 0; i < n_bins; i++) {
    bins.push(i * width + min);
    counts.push(0);
  }
  for (var i = 0; i < data.length; i++) {
    var bindex = Math.floor((data[i] - min) / width);
    if (bindex >= 0 && bindex < n_bins)
      counts[bindex]++;
  }
  return {bins: bins, counts: counts};
};

var getHistLayout = function(stats, title, color) {
  return {
    xaxis: { title: title },
    yaxis: { title: 'Frequency' },
    margin: {l: 65, r: 20, b: 40, t: 20 },
    shapes: [
      {
          type: 'rect',
          xref: 'x', yref: 'paper',
          x0: stats.pct05, y0: 0,
          x1: stats.pct95, y1: 1,
          fillcolor: '#000',
          opacity: 0.05,
          line: { width: 0 }
      },
      {
          type: 'rect',
          xref: 'x', yref: 'paper',
          x0: stats.pct25, y0: 0,
          x1: stats.pct75, y1: 1,
          fillcolor: '#000',
          opacity: 0.05,
          line: { width: 0 }
      },
      {
        type: 'line',
        xref: 'x', yref: 'paper',
        x0: stats.mean, y0: 0,
        x1: stats.mean, y1: 1,
        line: { color: 'rgb(' + color + ')', width: 2 }
      }
    ]
  };
};

function showMonteCarloResults(results) {

  var div = document.getElementById('mc');
  div.style.display = 'block';

  var colors = {
    'Patient': '51,102,153',
    'ClinicalTeam': '51,153,102',
    'Attending': '102,51,153'
  };


  var patientTrends = {
    labels: [ ],
    seenByPreferredAttending: [ ],
    seenByPreferredClinicalTeam: [ ],
    waitingForClinicalTeam: [ ],
    waitingForAttending: [ ],
    totalTimeInClinic: [ ],
  };

  var clinicalTeamTrends = {
    labels: [ ],
    patientsSeen: [ ],
    waitingForPatient: [ ],
    waitingForAttending: [ ],
  };

  var attendingTrends = {
    labels: [ ],
    patientsSeen: [ ],
    waitingForClinicalTeam: [ ],
  };

  results.patients.forEach(function(patient) {
    patientTrends.labels.push(patient.label);
    patientTrends.seenByPreferredAttending.push(patient.seenByPreferredAttending);
    patientTrends.seenByPreferredClinicalTeam.push(patient.seenByPreferredClinicalTeam);
    patientTrends.waitingForClinicalTeam.push(patient.waitingForClinicalTeam);
    patientTrends.waitingForAttending.push(patient.timeInState['PATIENT_WAITING_FOR_ATTENDING']);
    patientTrends.totalTimeInClinic.push(patient.totalTimeInClinic);
  });

  results.clinicalTeams.forEach(function(clinicalTeam) {
    clinicalTeamTrends.labels.push(clinicalTeam.label);
    clinicalTeamTrends.patientsSeen.push(clinicalTeam.patientsSeen);
    clinicalTeamTrends.waitingForPatient.push(clinicalTeam.timeInState['CLINICAL_TEAM_WAITING_FOR_PATIENT']);
    clinicalTeamTrends.waitingForAttending.push(clinicalTeam.waitingForAttending);
  });

  results.attendings.forEach(function(attending) {
    attendingTrends.labels.push(attending.label);
    attendingTrends.patientsSeen.push(attending.patientsSeen);
    attendingTrends.waitingForClinicalTeam.push(attending.timeInState['ATTENDING_WAITING_FOR_CLINICAL_TEAM']);
  });

  var getTimeTicks = function(min, max) {
    var ticks = { tickvals: [ ], ticktext: [ ] };
    for (var time = min; time <= max; time += 15) {
      ticks.tickvals.push(time);
      ticks.ticktext.push(Simulation.formatTime(time));
    }
    return ticks;
  };

  var setDurationTicks = function(yaxis) {
    var min = yaxis.range[0], max = yaxis.range[1];
    yaxis.tickvals = [ ];
    yaxis.ticktext = [ ];
    for (var time = min; time <= max; time += 15) {
      yaxis.tickvals.push(time);
      yaxis.ticktext.push(Simulation.formatDuration(time));
    }
  };

  var timeHist = hist(results.times.samples, results.params.targetTime - 60, results.params.targetTime + 60, 61);
  var timeData = [{
    x: timeHist.bins,
    y: timeHist.counts,
    name: 'Last patient checkout',
    fill: 'tozeroy',
    fillcolor: 'rgba(' + colors['Patient'] + ',0.5)',
    line: {shape: 'hv'},
    type: 'scatter',
    mode: 'none',
  }];
  var layout = getHistLayout(results.times, '', colors['Patient']);
  layout.xaxis = getTimeTicks(results.params.targetTime - 60, results.params.targetTime + 60);
  layout.xaxis.title = 'Last patient checked out';
  Plotly.newPlot('pltTimeHist', timeData,layout);

  var getPlotDataFromTimeStats = function(x, stats, color) {
    var getTrend = function(key) {
      var trend = [ ];
      stats.forEach(function(stat) {
        trend.push(stat[key]);
      });
      return trend;
    };
    var rgb = 'rgb(' + color + ')';
    var data = [
      {
        x: x, y: getTrend('pct05'),
        name: '05-pct',
        mode: 'lines',
        line: { width: 0, }
      }, {
        x: x, y: getTrend('pct95'),
        name: '95-pct',
        fill: 'tonexty',
        fillcolor: 'rgba(' + color + ',0.15)',
        mode: 'none',
      }, {
        x: x, y: getTrend('pct25'),
        name: '25-pct',
        mode: 'lines',
        line: { color: rgb, width: 1, dash: 'dot' }
      }, {
        x: x, y: getTrend('pct75'),
        name: '75-pct',
        fill: 'tonexty',
        fillcolor: 'rgba(' + color + ',0.15)',
        mode: 'lines',
        line: { color: rgb, width: 1, dash: 'dot' }
      }, {
        x: x, y: getTrend('pct50'),
        name: 'Median',
        line: { color: rgb, width: 3 }
      }, {
        x: x, y: getTrend('mean'),
        name: 'Mean',
        mode: 'markers',
        marker: { color: rgb, size: 4 }
      },
    ];
    return data;
  };

  var plotTimeTrend = function(options) {
    var layout = {
      yaxis: { title: options.title, range: options.range, hoverformat: '.1f', },
      margin: { l: 65, r: 20, b: 20, t: 20 },
      showlegend: false
    };
    setDurationTicks(layout.yaxis);
    Plotly.newPlot(
      options.id,
      getPlotDataFromTimeStats(options.labels, options.trend, options.color),
      layout
    );
  };

  var plotPatientsSeen = function(options) {
    var data = [ ];
    var min = options.trend[0].min;
    var max = options.trend[0].max;
    for (var i = min; i <= max; i++) {
      var values = [ ];
      options.trend.forEach(function(data, index) {
        var count = 0;
        for (var j = 0; j < data.samples.length; j++) {
          if (data.samples[j] == i)
            count++;
        }
        values.push(count / data.samples.length * 100);
      });
      var minOpacity = 0.2;
      var opacity = minOpacity + (1 - minOpacity) * (i  - min) / (max - min);
      data.push({
        x: options.labels,
        y: values,
        // opacity: opacity;
        name: i.toString(),
        marker: {color: 'rgba(' + options.color + ',' + opacity + ')'},
        type: 'bar',
      });
    }
    Plotly.newPlot(options.id, data, {
      barmode: 'stack',
      margin: {l: 65, r: 20, b: 30, t: 20 },
      yaxis: { title: options.title, ticksuffix: '%', hoverformat: '.1f' }
    });
  };

  var createPatientPlots = function() {

    plotTimeTrend({
      id: 'pltPatientWaitingForClinicalTeam',
      title: 'Patient waiting for clinical team',
      labels: patientTrends.labels,
      trend: patientTrends.waitingForClinicalTeam,
      range: [0, 60],
      color: colors.Patient
    });

    plotTimeTrend({
      id: 'pltPatientWaitingForAttending',
      title: 'Patient waiting for attending',
      labels: patientTrends.labels,
      trend: patientTrends.waitingForAttending,
      range: [0, 60],
      color: colors.Patient
    });

    plotTimeTrend({
      id: 'pltPatientTotalTimeInClinic',
      title: 'Patient total time in clinic',
      labels: patientTrends.labels,
      trend: patientTrends.totalTimeInClinic,
      range: [30, 180],
      color: colors.Patient
    });

    var data = [
      { x: patientTrends.labels, y: patientTrends.seenByPreferredClinicalTeam, name: 'Clinical team',
        line: { color: 'rgb('+colors.ClinicalTeam+')' } },
      { x: patientTrends.labels, y: patientTrends.seenByPreferredAttending, name: 'Attending', line: { color: 'rgb('+colors.Attending+')' } }
    ];
    var layout = {
      yaxis: { title: 'Seen by preferred', ticksuffix: '%', hoverformat: '.1f' },
      legend: {"orientation": "h"},
      margin: {l: 65, r: 20, b: 20, t: 20 },
    };
    Plotly.newPlot('pltPatientPreferred', data, layout);

  }

  var createClinicalTeamPlots = function() {
    plotPatientsSeen({
      id: 'pltClinicalTeamPatientsSeen',
      title: 'Patients seen by clinical team',
      labels: clinicalTeamTrends.labels,
      trend: clinicalTeamTrends.patientsSeen,
      color: colors.ClinicalTeam
    });

    plotTimeTrend({
      id: 'pltClinicalTeamWaitingForPatient',
      title: 'Clinical Team waiting for patient',
      labels: clinicalTeamTrends.labels,
      trend: clinicalTeamTrends.waitingForPatient,
      range: [0, 60],
      color: colors.ClinicalTeam
    });

    plotTimeTrend({
      id: 'pltClinicalTeamWaitingForAttending',
      title: 'Clinical Team waiting for attending',
      labels: clinicalTeamTrends.labels,
      trend: clinicalTeamTrends.waitingForAttending,
      range: [0, 60],
      color: colors.ClinicalTeam
    });
  };

  var createAttendingPlots = function() {

    plotPatientsSeen({
      id: 'pltAttendingPatientsSeen',
      title: 'Patients seen by attending',
      labels: attendingTrends.labels,
      trend: attendingTrends.patientsSeen,
      color: colors.Attending
    });

    /*
    plotTimeTrend({
      id: 'pltAttendingWaitingForClinicalTeam',
      title: 'Attending waiting for clinical team',
      labels: attendingTrends.labels,
      trend: attendingTrends.waitingForClinicalTeam,
      range: [0, 60],
      color: colors.Attending
    });
    */
    var range = [0, 60];
    var timeData = [];
    var combined = [];
    attendingTrends.waitingForClinicalTeam.forEach(function(data, index) {
      for (var i = 0; i < data.samples.length; i++) {
        combined.push(data.samples[i]);
      }
      var timeHist = hist(data.samples, range[0], range[1], (range[1] - range[0]) + 1);
      var minOpacity = 0.2;
      var opacity = minOpacity + (1 - minOpacity) * index / (attendingTrends.waitingForClinicalTeam.length);
      timeData.push({
        x: timeHist.bins,
        y: timeHist.counts,
        name: attendingTrends.labels[index],
        fill: 'tozeroy',
        fillcolor: 'rgba(' + colors['Attending'] + ',' + opacity + ')',
        line: {shape: 'hv'},
        type: 'scatter',
        mode: 'none',
      });
    });
    var combined = getStats(new Float64Array(combined));
    var layout = getHistLayout(combined, 'Attending waiting for clinical team', colors['Attending']);
    layout.xaxis.range = range;
    setDurationTicks(layout.xaxis);
    // layout.legend = {"orientation": "h"};
    Plotly.newPlot('pltAttendingWaitingForClinicalTeam', timeData, layout);
  };

  createPatientPlots();
  createClinicalTeamPlots();
  createAttendingPlots();
  visualize(results.worstCase, '<p>Showing worst case scenario encountered during Monte Carlo simulation</p>');
};

function visualize(sim, message) {

  message = message || '<p><strong>Hint:</strong> hover over the timeline labels to highlight relationships</p>';

  var timelines = document.getElementById('timelines');
  timelines.style.display = 'block';
  var scale = 5; // px per minute
  var info = document.getElementById('info');

  var createEvent = function(className, start, duration) {
    var event = document.createElement('div');
    var label = (duration + 0.5) | 0;
    if (className.includes('tick')) {
      label = Simulation.formatTime(start);
    } else {
      event.title = className;
      // event.onmouseover = function() { info.innerHTML = className; };
    }
    event.appendChild(document.createTextNode(label)); // round to nearest integer
    event.className = className;
    event.style.left = start * scale + 'px';
    event.style.width = duration * scale + 'px';
    return event;
  };

  var highlightTimelines = function(highlightFilter) {
    document.querySelectorAll('.timeline').forEach(function(timeline) {
      if (highlightFilter(timeline)) {
        if (timeline.classList.contains('hidden'))
          timeline.classList.remove('hidden');
      } else {
        if (!timeline.classList.contains('hidden'))
          timeline.classList.add('hidden');
      }
    });
  };

  var resetTimelines = function() {
    document.querySelectorAll('.timeline').forEach(function(timeline) {
      if (timeline.classList.contains('hidden'))
        timeline.classList.remove('hidden');
    });
  };

  var createTimeline = function(actor) {
    var timeline = document.createElement('div');
    timeline.className = 'timeline';

    var label = document.createElement('div');
    label.appendChild(document.createTextNode(actor.id));
    label.className = 'label ' + actor.type;
    timeline.appendChild(label);
    timeline.setAttribute('data-id', actor.id);

    if (actor.type == 'Patient') {
      label.onmouseover = function(e) {
        highlightTimelines(function(timeline) {
          var dataId = timeline.getAttribute('data-id');
          return (dataId == actor.id || dataId == actor.clinicalTeam.id || dataId == actor.attending.id);;
        });
      };
      label.onmouseout = resetTimelines;
    }

    if (actor.type == 'ClinicalTeam') {
      var patientsSeenIds = [ ];
      var attendingIds = [ ];
      actor.patientsSeen.forEach(function(patient) {
        patientsSeenIds.push(patient.id);
        attendingIds.push(patient.attending.id);
      });
      label.onmouseover = function(e) {
        highlightTimelines(function(timeline) {
          var id = timeline.getAttribute('data-id');
          return (id == actor.id ||
            patientsSeenIds.indexOf(id) !== -1 ||
            attendingIds.indexOf(id) !== -1);
        });
      };
      label.onmouseout = resetTimelines;
    }

    if (actor.type == 'Attending') {
      var patientsSeenIds = [ ];
      var clinicalTeamIds = [ ];
      actor.patientsSeen.forEach(function(patient) {
        patientsSeenIds.push(patient.id);
        clinicalTeamIds.push(patient.clinicalTeam.id);
      });
      label.onmouseover = function(e) {
        highlightTimelines(function(timeline) {
          var dataId = timeline.getAttribute('data-id');
          return (dataId == actor.id ||
            patientsSeenIds.indexOf(timeline.getAttribute('data-id')) !== -1 ||
            clinicalTeamIds.indexOf(timeline.getAttribute('data-id')) !== -1);
        });
      };
      label.onmouseout = resetTimelines;
    }

    var events = document.createElement('div');
    events.className = 'events ' + actor.type;
    for (var i = 0; i < 13; i++) {
      var className = 'tick';
      if (i % 4 == 0)
          className += ' hour';
      var event = createEvent(className, i * 15, 15);
      events.appendChild(event);
    }
    actor.timeline.forEach(function(event) {
      var duration = event.end - event.start;
      if (duration > 0) {
        var event = createEvent(Actor.stateLabels[event.stateCode], event.start, duration);
        events.appendChild(event);
      }
    });
    timeline.appendChild(events);
    return timeline;
  };

  legend.innerHTML = '';
  timelines.innerHTML = message;

  // ticks
  var timeline = createTimeline({
    id: '',
    type: 'time',
    timeInState: { },
    timeline: [ ],
  });
  timelines.appendChild(timeline);

  sim.actors.forEach(function(actor, i) {
    var timeline = createTimeline(actor);
    if (i + 1 < sim.actors.length && sim.actors[i+1].type != actor.type)
      timeline.classList.add('last');
    timelines.appendChild(timeline);
  });

  var timeline = createTimeline({
    id: '',
    type: 'time',
    timeInState: { },
    timeline: [ ],
  });
  timelines.appendChild(timeline);

}

</script>
</body>
</html>